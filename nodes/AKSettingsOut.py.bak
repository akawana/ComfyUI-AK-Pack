
import json


class AKSettingsOut:
    @classmethod
    def INPUT_TYPES(s):
        required = {
            "ak_settings_0": ("STRING", {"forceInput": True}),
        }
        optional = {}
        for i in range(1, 10):
            optional[f"ak_settings_{i}"] = ("STRING", {"forceInput": True})
        return {
            "required": required,
            "optional": optional,
        }

    RETURN_TYPES = ("INT", "FLOAT", "FLOAT", "INT")
    RETURN_NAMES = ("seed", "cfg", "denoise", "xy_variations")
    FUNCTION = "output_settings"
    CATEGORY = "AK/settings"

    @classmethod
    def IS_CHANGED(cls, **kwargs):
        return float("NaN")

    def __init__(self):
        self._hashes = [None] * 10
        self._last_values = (0, 0.0, 0.0, 1)

    def output_settings(
        self,
        ak_settings_0,
        ak_settings_1=None,
        ak_settings_2=None,
        ak_settings_3=None,
        ak_settings_4=None,
        ak_settings_5=None,
        ak_settings_6=None,
        ak_settings_7=None,
        ak_settings_8=None,
        ak_settings_9=None,
    ):
        inputs = [
            ak_settings_0,
            ak_settings_1,
            ak_settings_2,
            ak_settings_3,
            ak_settings_4,
            ak_settings_5,
            ak_settings_6,
            ak_settings_7,
            ak_settings_8,
            ak_settings_9,
        ]

        changed_idx = None
        changed_values = None
        last_not_none_values = None

        for idx, s in enumerate(inputs):
            if s is None:
                continue
            if not isinstance(s, str):
                continue
            if not s.strip():
                continue

            try:
                data = json.loads(s)
            except Exception:
                continue

            h = data.get("hash", None)
            if h is None:
                continue

            seed = int(data.get("seed", 0))
            cfg = float(data.get("cfg", 0.0))
            denoise = float(data.get("denoise", 0.0))
            xy = int(data.get("xy_variations", 1))

            last_not_none_values = (seed, cfg, denoise, xy)

            prev = self._hashes[idx]
            if prev != h and changed_idx is None:
                changed_idx = idx
                changed_values = (seed, cfg, denoise, xy)

            self._hashes[idx] = h

        if changed_idx is not None and changed_values is not None:
            self._last_values = changed_values
        elif last_not_none_values is not None:
            self._last_values = last_not_none_values

        return self._last_values


NODE_CLASS_MAPPINGS = {
    "AKSettingsOut": AKSettingsOut
}

NODE_DISPLAY_NAME_MAPPINGS = {
    "AKSettingsOut": "AK Settings Out"
}
